<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parent Dashboard – Study-IQ Classes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0" />
  <style>
    .progress-ring {
      transform: rotate(-90deg);
    }
    .progress-ring circle {
      transition: stroke-dasharray 0.3s ease;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-orange-50 font-inter">

  <!-- Navbar -->
  <nav class="bg-white/90 border-b border-indigo-100 fixed top-0 w-full z-50 shadow">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-6 py-4">
      <a href="index.html" class="text-2xl font-extrabold text-indigo-600">Study-IQ</a>
      <div class="flex gap-8">
        <a href="index.html" class="font-semibold text-indigo-700">Home</a>
        <a href="course.html" class="font-semibold text-indigo-700">Courses</a>
        <a href="about.html" class="font-semibold text-indigo-700">About</a>
        <button id="logout" class="bg-gradient-to-r from-orange-500 to-indigo-600 text-white rounded-lg font-bold px-6 py-2 shadow hover:scale-105 transition">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Dashboard Header -->
  <section class="pt-32 pb-10 text-center">
    <div class="max-w-3xl mx-auto px-6">
      <h1 class="text-5xl font-bold text-indigo-700 mb-3">Parent Dashboard</h1>
      <p class="text-lg text-gray-700 mb-7">Monitor your child's progress, attendance, and academic performance</p>
    </div>
  </section>

  <!-- Link Student Section -->
  <section class="py-8 bg-white/50">
    <div class="max-w-4xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">Link Your Child's Account</h2>
        <div id="link-form" class="flex gap-4">
          <input type="email" id="student-email" placeholder="Enter student's email" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <button id="link-student" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">Link Student</button>
        </div>
        <p id="link-message" class="mt-2 text-sm text-gray-600 hidden"></p>
      </div>
    </div>
  </section>

  <!-- Students Overview -->
  <section class="py-16">
    <div class="max-w-7xl mx-auto px-6">
      <h2 class="text-3xl font-bold text-orange-600 mb-8 text-center">Your Children's Progress</h2>
      <div id="students-container" class="space-y-8">
        <!-- Students will be loaded here -->
        <div class="text-center text-gray-500">
          <i class="fas fa-users text-4xl mb-4"></i>
          <p>No students linked yet. Please link your child's account above.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-white/90 border-t border-indigo-100 shadow-md mt-8">
    <div class="max-w-7xl mx-auto px-6 py-6 flex flex-col md:flex-row text-center md:text-left justify-between items-center gap-5">
      <span class="text-gray-600 font-semibold">© 2025 Study-IQ Classes. All rights reserved.</span>
      <div class="flex gap-4 text-lg">
        <a href="#" class="text-indigo-600 hover:text-orange-500"><i class="fab fa-twitter"></i></a>
        <a href="#" class="text-indigo-600 hover:text-orange-500"><i class="fab fa-facebook"></i></a>
        <a href="#" class="text-indigo-600 hover:text-orange-500"><i class="fab fa-instagram"></i></a>
        <a href="#" class="text-indigo-600 hover:text-orange-500"><i class="fab fa-youtube"></i></a>
      </div>
    </div>
  </footer>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Load parent dashboard data
    async function loadParentDashboard() {
      try {
        const response = await fetch('http://localhost:3000/api/parent/dashboard', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          displayStudents(data.students);
        } else {
          console.error('Failed to load parent dashboard');
        }
      } catch (error) {
        console.error('Error loading parent dashboard:', error);
      }
    }

    function displayStudents(students) {
      const container = document.getElementById('students-container');

      if (students.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-500">
            <i class="fas fa-users text-4xl mb-4"></i>
            <p>No students linked yet. Please link your child's account above.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = students.map(student => `
        <div class="bg-white rounded-xl shadow-xl overflow-hidden">
          <!-- Student Header -->
          <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-2xl font-bold">${student.name}</h3>
                <p class="text-indigo-100">Student ID: ${student.id}</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold">${student.xp || 0}</div>
                <div class="text-sm text-indigo-100">XP Points</div>
              </div>
            </div>
          </div>

          <!-- Student Stats -->
          <div class="p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="text-center">
                <div class="text-2xl font-bold text-orange-600">${student.streak}</div>
                <div class="text-sm text-gray-600">Day Streak</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-indigo-600">${student.badges}</div>
                <div class="text-sm text-gray-600">Badges</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600">${student.doubts}</div>
                <div class="text-sm text-gray-600">Doubts Asked</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">Level ${student.level || 1}</div>
                <div class="text-sm text-gray-600">Current Level</div>
              </div>
            </div>

            <!-- Course Progress -->
            <div class="mb-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-3">Course Progress</h4>
              <div class="space-y-3">
                ${student.enrolledCourses.map(course => `
                  <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                      <div class="font-medium text-gray-800">${course.name}</div>
                      <div class="text-sm text-gray-600">Progress: ${course.progress}%</div>
                    </div>
                    <div class="w-16 h-16 relative">
                      <svg class="progress-ring w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                              fill="none" stroke="#e5e7eb" stroke-width="3"/>
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                              fill="none" stroke="#10b981" stroke-width="3"
                              stroke-dasharray="${course.progress * 0.283}, 100"/>
                      </svg>
                      <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-700">
                        ${course.progress}%
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Quiz Performance -->
            <div class="mb-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-3">Recent Quiz Results</h4>
              <div class="space-y-2">
                ${student.quizResults.slice(-3).map(result => `
                  <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                    <div>
                      <div class="font-medium text-gray-800">${result.subject} Quiz</div>
                      <div class="text-sm text-gray-600">${new Date(result.completedAt).toLocaleDateString()}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-lg font-bold ${result.score >= 80 ? 'text-green-600' : result.score >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                        ${result.score}%
                      </div>
                    </div>
                  </div>
                `).join('') || '<p class="text-gray-500 text-sm">No quiz results yet</p>'}
              </div>
            </div>

            <!-- Attendance -->
            <div>
              <h4 class="text-lg font-semibold text-gray-800 mb-3">Recent Attendance</h4>
              <div class="space-y-2">
                ${student.attendance.slice(-5).map(att => `
                  <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <div>
                      <div class="font-medium text-gray-800">Live Class</div>
                      <div class="text-sm text-gray-600">${new Date(att.joinedAt).toLocaleDateString()}</div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="material-symbols-rounded text-green-600">check_circle</span>
                      <span class="text-sm font-medium text-green-700">Present</span>
                    </div>
                  </div>
                `).join('') || '<p class="text-gray-500 text-sm">No attendance records yet</p>'}
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Link student functionality
    document.getElementById('link-student').addEventListener('click', async () => {
      const studentEmail = document.getElementById('student-email').value;
      const messageDiv = document.getElementById('link-message');

      if (!studentEmail) {
        messageDiv.textContent = 'Please enter a student email';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        messageDiv.classList.remove('hidden');
        return;
      }

      try {
        const response = await fetch('http://localhost:3000/api/parent/link-student', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ studentEmail })
        });

        const data = await response.json();

        if (response.ok) {
          messageDiv.textContent = 'Student linked successfully!';
          messageDiv.className = 'mt-2 text-sm text-green-600';
          document.getElementById('student-email').value = '';
          loadParentDashboard(); // Reload dashboard
        } else {
          messageDiv.textContent = data.message || 'Failed to link student';
          messageDiv.className = 'mt-2 text-sm text-red-600';
        }
        messageDiv.classList.remove('hidden');
      } catch (error) {
        console.error('Error linking student:', error);
        messageDiv.textContent = 'Error linking student';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        messageDiv.classList.remove('hidden');
      }
    });

    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      window.location.href = 'index.html';
    });

    loadParentDashboard();
  </script>
</body>
</html>
